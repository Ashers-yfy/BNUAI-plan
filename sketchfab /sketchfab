import requests
import json
import time
import pyautogui
import pyperclip

# ==================ã€å‚æ•°è®¾ç½®ã€‘==================
CATEGORY = "art-abstract"   # åˆ†ç±» slug
LICENSE = "cc0"             # License slugï¼Œä¾‹å¦‚ cc0, by, by-nc
LIMIT = 300                 # æŠ“å–æ¨¡å‹æ•°é‡ä¸Šé™
COOKIES_FILE = "cookies.json"                    //é…ç½®cookies.json
OUTPUT_FILE = f"sketchfab_{CATEGORY}_{LIMIT}.json"

CLICK_DELAY = 2
BUTTON_POS_FILE = "button_positions.json"    //é…ç½®button.json
SAVE_LOG = "download_log.json"

# ==================ã€å‡½æ•°ï¼šåŠ è½½ cookiesã€‘==================
def load_cookies():
    cookies_list = json.load(open(COOKIES_FILE, "r", encoding="utf-8"))
    return {c["name"]: c["value"] for c in cookies_list}

# ==================ã€å‡½æ•°ï¼šæŠ“å– Sketchfab æ¨¡å‹é“¾æ¥ï¼ˆå»é‡ç‰ˆï¼‰ã€‘==================
def fetch_model_links():
    url = "https://sketchfab.com/v3/search"
    params = {
        "type": "models",
        "categories": CATEGORY,
        "features": "downloadable",
        "licenses": LICENSE,
        "count": 48,
    }

    cookies = load_cookies()
    all_links = []
    seen_uids = set()
    cursor = None

    while len(all_links) < LIMIT:
        if cursor:
            params["cursor"] = cursor

        print(f"ğŸ“¡ è¯·æ±‚: {url}  cursor={cursor}")
        resp = requests.get(url, params=params, cookies=cookies)

        if resp.status_code != 200:
            print(f"âŒ è¯·æ±‚å¤±è´¥: {resp.status_code} {resp.text[:200]}")
            break

        data = resp.json()
        results = data.get("results", [])
        if not results:
            print("âš ï¸ æ²¡æœ‰æ›´å¤šæ¨¡å‹äº†ã€‚")
            break

        new_count, dup_count = 0, 0
        for m in results:
            uid = m.get("uid")
            link = m.get("viewerUrl")
            if not uid or not link:
                continue
            if uid in seen_uids:
                dup_count += 1
                continue

            seen_uids.add(uid)
            all_links.append(link)
            new_count += 1
            print(f"âœ… æŠ“åˆ°: {link}")

            if len(all_links) >= LIMIT:
                break

        print(f"ğŸ“ˆ æœ¬é¡µæ–°å¢ {new_count} æ¡ï¼Œé‡å¤ {dup_count} æ¡ï¼Œæ€»å…± {len(all_links)} æ¡")

        cursor = data.get("cursors", {}).get("next")
        if not cursor:
            print("ğŸš« æ²¡æœ‰ä¸‹ä¸€é¡µ cursor äº†ã€‚")
            break

        time.sleep(1.2)  # å»¶è¿Ÿé˜²ç¼“å­˜

    with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
        json.dump(all_links, f, ensure_ascii=False, indent=2)

    print(f"\nğŸ“¦ å…±æŠ“å– {len(all_links)} ä¸ªå»é‡åæ¨¡å‹é“¾æ¥ï¼Œå·²ä¿å­˜åˆ° {OUTPUT_FILE}")
    return all_links

# ==================ã€å‡½æ•°ï¼šåŠ è½½æŒ‰é’®åæ ‡ã€‘==================
def load_button_positions():
    with open(BUTTON_POS_FILE, "r", encoding="utf-8") as f:
        pos = json.load(f)
    return pos

# ==================ã€å‡½æ•°ï¼šxd.studio è‡ªåŠ¨åŒ–ä¸‹è½½ã€‘==================
def xdstudio_download(model_links, positions):
    success, fail, paid = [], [], []

    print("\nâ³ è¯·ç¡®ä¿ xd.studio çª—å£å·²æ‰“å¼€ï¼Œ5 ç§’åå¼€å§‹è‡ªåŠ¨ä¸‹è½½...")
    time.sleep(5)

    for i, link in enumerate(model_links, 1):
        print(f"\n({i}/{len(model_links)}) æ·»åŠ ä¸‹è½½ä»»åŠ¡ï¼š{link}")

        if "store" in link:
            print("ğŸ’° æ£€æµ‹åˆ°ä»˜è´¹æ¨¡å‹ï¼Œè·³è¿‡")
            paid.append(link)
            continue

        try:
            # ç‚¹å‡»â€œæ–°å»ºä¸‹è½½â€
            pyautogui.moveTo(positions['new'][0], positions['new'][1], duration=0.3)
            pyautogui.click()
            time.sleep(0.3)

            # ç²˜è´´é“¾æ¥
            pyperclip.copy(link)
            pyautogui.hotkey("ctrl", "v")
            time.sleep(0.3)

            # ç‚¹å‡»â€œç¡®å®šâ€
            pyautogui.moveTo(positions['ok'][0], positions['ok'][1], duration=0.3)
            pyautogui.click()
            time.sleep(CLICK_DELAY)

            success.append(link)

        except Exception as e:
            print(f"âŒ ä¸‹è½½å¤±è´¥: {e}")
            fail.append(link)

    # ä¿å­˜æ—¥å¿—
    log_data = {"æˆåŠŸ": success, "å¤±è´¥": fail, "ä»˜è´¹": paid}
    with open(SAVE_LOG, "w", encoding="utf-8") as f:
        json.dump(log_data, f, ensure_ascii=False, indent=2)

    print("\nğŸ“Š ä¸‹è½½å®Œæˆï¼")
    print(f"âœ… æˆåŠŸ {len(success)} | âŒ å¤±è´¥ {len(fail)} | ğŸ’° ä»˜è´¹ {len(paid)}")
    print(f"ğŸ§¾ è®°å½•å·²ä¿å­˜è‡³ {SAVE_LOG}")

# ==================ã€ä¸»æµç¨‹ã€‘==================
def main():
    print("ğŸš€ å¼€å§‹æŠ“å– Sketchfab æ¨¡å‹é“¾æ¥...")
    links = fetch_model_links()

    if not links:
        print("âŒ æœªæŠ“å–åˆ°æ¨¡å‹é“¾æ¥ï¼Œç¨‹åºç»“æŸã€‚")
        return

    print("\nâœ… æŠ“å–å®Œæˆï¼Œå‡†å¤‡è‡ªåŠ¨ä¸‹è½½...")
    positions = load_button_positions()
    xdstudio_download(links, positions)

# ==================ã€å…¥å£ã€‘==================
if __name__ == "__main__":
    pyautogui.FAILSAFE = True
    main()
